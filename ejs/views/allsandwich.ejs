<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AllSandwich</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text&family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">
    
    <%- include('partials/navbar') %>
    
    <div class="container mt-4 mb-5">
        <div class="container mt-4">
            <div class="row mt-3">
                <div class="col-md-9 d-flex justify-content-between gap-3">
                    <div class="flex-grow-1 bg-light p-3 text-center rounded-3"><a class="nav-link" href="/allsandwich">‡πÄ‡πÄ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ã</a></div>
                    <div class="flex-grow-1 bg-light p-3 text-center rounded-3"><a class="nav-link" href="/comboset">‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πâ</a></div>
                    <div class="flex-grow-1 bg-light p-3 text-center rounded-3"><a class="nav-link" href="/appetizers">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</a></div>
                    <div class="flex-grow-1 bg-light p-3 text-center rounded-3"><a class="nav-link" href="/drinks">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</a></div>
                </div>
            </div>
        </div>
        
        <div class="row mt-5">
            <div class="col-md-9">
                <h3>‡πÄ‡πÄ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ã</h3>
                <div class="row mt-3 mb-5">
                    <% sandwiches.forEach(sandwich => { %>
                        <div class="col-md-4">
                            <div class="menu-item text-start mt-2" style="border: 2px solid #009444; padding: 20px; border-radius: 15px;">
                                <img src="<%= sandwich.img %>" class="img-fluid w-100" style="height: 180px; object-fit: cover; border-radius: 15px;">
                                <p class="text-success fw-bold small mt-4"><%= sandwich.price %> THB</p>
                                <p class="fw-bold"><%= sandwich.name %></p> 
                                <p class="fw-light"><%= sandwich.thname %></p>
                                <div class="hover-content">
                                    <input type="number" class="form-control qty-input" value="1" min="1">
                                    <button class="btn btn-sm btn-success mt-2 w-100" 
                                        onclick="console.log('Debug:', '<%= sandwich.menu_id %>', '<%= sandwich.name %>', '<%= sandwich.price %>'); addToCart('<%= sandwich.menu_id %>', '<%= sandwich.name %>', '<%= sandwich.price %>')">
                                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <div class="cart-box">
            <h4>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
            <p>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤...</p>
            <div class="cart-footer">
                <button class="btn btn-success w-100" onclick="checkout()">
                    <a href="/checkout" class="nav-link">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
                </button>
            </div>
        </div>
    </div>

    <script>
        async function addToCart(productId, productName, price) {
            console.log("üöÄ Debug: ", { productId, productName, price }); // ‚úÖ Debug ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á API

            if (!productId || !productName || !price) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            const response = await fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    product_id: productId, 
                    product_name: productName, 
                    price: price 
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                fetchCart();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.error);
            }
        }

        async function fetchCart() {
            const response = await fetch('/cart/items');
            const data = await response.json();
        
            const cartBox = document.querySelector('.cart-box p');
            if (data.cart.length > 0) {
                cartBox.innerHTML = data.cart.map(item => `
                    <div class="cart-item">
                        <p>${item.product_name} x${item.quantity}</p>
                        <button onclick="removeFromCart(${item.id})">‡∏•‡∏ö</button>
                    </div>
                `).join('');
            } else {
                cartBox.innerHTML = "‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤";
            }
        }
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ `fetchCart()` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.addEventListener('DOMContentLoaded', fetchCart);

        
        async function removeFromCart(cartId) {
            console.log("üö® ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ cart_id:", cartId); // ‚úÖ Debug

            const response = await fetch('/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cart_id: cartId })
            });

            const data = await response.json();
            if (response.ok) {
                alert('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                fetchCart(); // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.error);
            }
        }
        </script>
        
        
    
    <%- include('partials/footer') %>
    
</body>
</html>
